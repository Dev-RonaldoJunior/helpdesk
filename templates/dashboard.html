<!DOCTYPE html>
<!-- Documento HTML5 -->
<html lang="pt-br">
<!-- Define o idioma como Português do Brasil -->

<head>
    <!-- Charset para suportar acentos -->
    <meta charset="UTF-8">

    <!-- Responsividade (celular / tablet) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Título da aba do navegador -->
    <title>Dashboard - Help Desk</title>

    <!-- Importa o CSS dentro da pasta /static do Flask -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

    <!-- Título principal da página -->
    <h1>Dashboard - Help Desk</h1>

    <!-- =======================================================
         PERFIL DO USUÁRIO LOGADO (NÍVEL)
         session.get('nivel'):
         0 = Usuário comum
         1 = Atendente
         2 = Administrador
         ======================================================= -->
    {% if session.get('nivel') == 2 %}
        <p><strong>Perfil:</strong> Administrador</p>
    {% elif session.get('nivel') == 1 %}
        <p><strong>Perfil:</strong> Atendente</p>
    {% else %}
        <p><strong>Perfil:</strong> Usuário</p>
    {% endif %}

    <!-- Mensagem simples -->
    <p>Bem-vindo ao sistema de chamados!</p>

    <!-- Título da seção -->
    <h3>Lista de chamados</h3>

    <!-- =======================================================
         LISTA DE CHAMADOS
         A variável "tickets" vem do backend (Flask) no render_template

         IMPORTANTE:
         O backend precisa retornar os campos na ordem correta,
         pois aqui você está usando ticket[0], ticket[1], etc.

         Ordem esperada pelo seu HTML:

         ticket[0]  = tickets.id
         ticket[1]  = tickets.titulo
         ticket[2]  = tickets.descricao
         ticket[3]  = tickets.status
         ticket[4]  = tickets.created_at
         ticket[5]  = tickets.started_at
         ticket[6]  = tickets.closed_at
         ticket[7]  = tickets.is_hidden
         ticket[8]  = creator.email
         ticket[9]  = attendant.email

         >>> NOVOS CAMPOS (para ocultação):
         ticket[10] = hidden_by.email (quem ocultou)
         ticket[11] = tickets.hidden_at (quando ocultou)

         (Esses dois campos só aparecem se você adicionou eles no SELECT!)
         ======================================================= -->

    {% if tickets %}
        <!-- Lista não ordenada -->
        <ul>

            <!-- Percorre cada ticket -->
            {% for ticket in tickets %}
                <li>

                    <!-- Título do ticket -->
                    <strong>Chamado: 
                        <a href="{{ url_for('ticket_detail', ticket_id=ticket[0]) }}">
                            {{ ticket[1] }}
                        </a>
                    </strong><br><br>

                    <!-- =======================================================
                         STATUS DO CHAMADO
                         Se is_hidden = 1, mostra como "Ocultado"
                         Caso contrário mostra o status normal
                         ======================================================= -->
                    {% if ticket[7] == 1 %}
                        <em><strong>Status:</strong> Ocultado</em><br>
                    {% else %}
                        <em><strong>Status:</strong> {{ ticket[3] }}</em><br>
                    {% endif %}

                    <br>

                    <!-- =======================================================
                         INFO EXTRA DE OCULTAÇÃO (SÓ ADMIN VÊ)
                         Aparece apenas se:
                         - usuário for admin (nivel 2)
                         - ticket estiver oculto (is_hidden = 1)
                         ======================================================= -->
                    {% if session.get('nivel') == 2 and ticket[7] == 1 %}
                        <small>

                            <!-- Quem ocultou o ticket -->
                            <strong>Ocultado por:</strong>
                            {% if ticket[10] %}
                                {{ ticket[10] }}
                            {% else %}
                                (não registrado)
                            {% endif %}
                            <br>

                            <!-- Quando foi ocultado -->
                            <strong>Ocultado em:</strong>
                            {% if ticket[11] %}
                                {{ ticket[11] }}
                            {% else %}
                                (não registrado)
                            {% endif %}

                        </small>
                        <br><br>
                    {% endif %}

                    <!-- =======================================================
                         BOTÕES DE AÇÃO (ATENDENTE E ADMIN)
                         Somente nível 1 e 2 conseguem fazer ações
                         ======================================================= -->
                    {% if session.get('nivel') in [1, 2] %}

                        <!-- Só mostra botões se o ticket NÃO estiver oculto -->
                        {% if ticket[7] == 0 %}

                            <!-- Se estiver "Aberto", pode iniciar atendimento -->
                            {% if ticket[3] == 'Aberto' %}
                                <a href="{{ url_for('start_ticket', ticket_id=ticket[0]) }}">
                                    Iniciar atendimento
                                </a>
                                <br>
                            {% endif %}

                            <!-- Se estiver "Em andamento", pode fechar -->
                            {% if ticket[3] == 'Em andamento' %}
                                <a href="{{ url_for('close_ticket', ticket_id=ticket[0]) }}">
                                    Fechar chamado
                                </a>
                                <br>
                            {% endif %}

                            <!-- Ocultar chamado (soft delete) -->
                            <a href="{{ url_for('hide_ticket', ticket_id=ticket[0]) }}"
                               onclick="return confirm('Deseja ocultar este chamado?');">
                                Ocultar
                            </a>
                            <br>

                        {% endif %}

                    {% endif %}

                    <!-- =======================================================
                         BOTÃO DESOCULTAR (SÓ ADMIN)
                         Aparece apenas se:
                         - admin (nivel 2)
                         - ticket oculto (is_hidden = 1)
                         ======================================================= -->
                    {% if session.get('nivel') == 2 and ticket[7] == 1 %}
                        <a href="{{ url_for('unhide_ticket', ticket_id=ticket[0]) }}"
                           onclick="return confirm('Deseja desocultar este chamado?');">
                            Desocultar
                        </a>
                        <br>
                    {% endif %}

                </li>

                <!-- Separador entre chamados -->
                <hr>
            {% endfor %}

        </ul>

    {% else %}
        <!-- Caso não tenha chamados -->
        <p>Nenhum chamado encontrado.</p>
    {% endif %}

    <br>

    <!-- Link para criar um novo chamado -->
    <a href="{{ url_for('create_ticket') }}">Criar novo chamado</a><br>

    <!-- Logout -->
    <a href="{{ url_for('logout') }}">Logout</a>

</body>
</html>
